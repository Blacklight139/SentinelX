name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        default: false
        type: boolean

env:
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  release:
    name: Create Release ${{ env.VERSION }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
    
    - name: Build release packages
      working-directory: ./server
      run: |
        # 设置版本
        export VERSION=${{ env.VERSION }}
        chmod +x build.sh
        ./build.sh
    
    - name: Create release notes
      id: release_notes
      uses: ffurrer2/extract-release-notes@v1
      with:
        path: ./CHANGELOG.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.VERSION }}
        name: SentinelX ${{ env.VERSION }}
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          server/release/*
          server/build/checksums.sha256
        generate_release_notes: true
        discussion_category_name: "Announcements"
    
    - name: Notify success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        channel: '#releases'
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}